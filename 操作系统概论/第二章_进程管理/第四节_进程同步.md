## 第四节 进程同步

多任务操作系统支持多个进程并发执行，并发执行的进程共享系统的软件和硬件资源。

操作系统同步机制的主要任务就是要保证多任务共享系统资源的情况下，程序执行能得到正确的结果。

### 一、进程同步的基本概念

进程同步有两个任务：

一是对具有资源共享关系的进程，保证诸进程以互斥的方式访问临界资源。临界资源是必须以互斥方式访问的共享资源。

二是对具有相互合作关系的进程，保证互相合作的诸进程协调执行。相互合作的进程可能同时存在资源共享的关系。

为了说明什么是临界资源，先回忆前面p1、p2两个进程并发执行，counter是全局变量，初始值为0，p1、p2两个进程分别对counter做加1操作，代码如下。

```
p1
{	...
	counter = counter + 1
	...
}
p2
{	...
	counter = counter + 1
	...
}
```
若当前counter=0，p1和p2各执行一次后，counter的正确值应该是2，但是当p1和p2在经过编译后，必须分别经过下列指令的执行，才能完成counter=counter+1的功能。
```
p1
{	...
	register1 = counter;
	register1 = register1 + 1;
	counter = register1;
	...
}
p2
{	...
	register2 = counter;
	register2 = register2 + 1;
	counter = register2;
	...
}
```
p1、p2并发执行时，指令的执行序列可能出现各种组合，当按下列顺序执行时，会发生counter计数错误。
```
register1 = counter;		// 执行结果：register1 = 0
register1 = register1 + 1;	// 执行结果：register1 = 1
register2 = counter;		// 执行结果：register2 = 0
register2 = register2 + 1;	// 执行结果：register2 = 1
counter = register1;		// 执行结果：counter = 1
counter = register2;		// 执行结果：counter = 1

```
执行结果是counter=1，而正确结果应该是counter=2。

如果p1和p2以互斥的方式去访问counter，也就是说，如果p1先开始对counter的访问，p2就必须等待p1对counter的访问完全结束，再开始对counter的访问。反之，如果p2先开始对counter的访问，p1就必须等待p2对counter的访问完全结束，再开始对counter的访问。那么p1和p2对counter访问指令的交错执行的情况就不会出现，计算结果的错误也就不会出现了。p1和p2以互斥的方式去访问counter的含义是在p1和p2中的任意一个进程执行counter+1操作的一系列指令的过程中，不允许另一个进程执行访问counter的操作。类似counter这样必须以互斥方式访问的共享资源称为临界资源。

在设计操作系统时，设计人员必须严格界定系统中的哪些资源是临界资源，通过同步机
制保证系统运行过程中，对临界资源的访问进行有效控制。

临界区是进程中访问临界资源的那段代码。访问临界资源是通过执行临界区代码来实现的，如果能使程序以互斥的方式进入临界区，就能够实现对临界资源的互斥访问。这一点可以通过在临界区前面加进入区代码，在临界区后面加退出区代码来实现。进入区代码在临界区代码之前执行，检查进程是否可以进入临界区并对临界区“加锁”。退出区代码在临界区代码之后执行，完成释放临界区访问权的功能。

在进程中，可以采用下列模式的代码来实现对临界资源的互斥访问。
```
{
	...
	进入区（Entry Section）；
		临界区（Critical Section）；
	退出区（Exit Section）；
}
```

### 二、同步机制应遵循的准则

当存在多种可选的同步方案时，可能是硬件或软件的不同，也可能是算法的不同，根据什么来权衡利弊，做出怡当的选择呢？对于一种同步技术，如何对它收确性和性能做出评
价呢？同步机制应遵循的准则可以为人们提供判断、选择和评价的参考依据。

#### 1.空闲让进

当没有进程处于临界区时，表明临界资源处于空闲状态，应允许一个请求进入临界区的进程立即进入自己的临界区，以有效地利用临界资源。

#### 2.忙则等待

当已有进程进入临界区时，表明临界资源正在被访问，因而其他试图进入临界区的进程
必须等待，以保证对临界资源的互斥访问。

#### 3.有限等待

对要求访问临界资源的进程，应保证在有限时间内能进人自己的临界区，以免进程陷人
无限等待的状态。

#### 4.让权等待

当进程申请不到共享资源的访回权时，应立即释放处理机，以免进程哈人“忙等”状态，
浪费CPU资源。

### 三、信号量机制

在信号量机制中，用某种类型的变量，即信号量的取值来表示资源的使用状况，或某种事件是否发生，以此为基础实现进程的同步。本节将介绍整型信号量机制、记录型信号量机
制、AND型信号量机制。

交通信号灯的作用是通过灯的不同颜色告知车辆应如何行驶，信号量机制类似这种信号灯的作用。对不同的共享资源设置被称为信号量的变量，用信号量的取值来表示资源的使用
状况，或某种事件是否发生。通过信号量的取值来判断进程是否能访问与信号量对应的共享资源。

#### 1.整型信号量机制

整型信号量是表示共享资源状态且只能由特殊的原子操作改变的整型量。其完成同步功能的原理是定义一个整型变量，用整型变量值来标记资源的使用情况。如果整型量>0，说明有可用资源：如果整型量≤0，说明资源忙，进程必须等待。对于一次只允许一个进程访问的临界资源，可定义一个用于互斥的整型信号量，并将其初始化为1。整型信号量的值只能通过两个特定的原子操作wait和signal来改变。

##### (1)整型信号量的wait和signal操作

s定义为整型信号量。
```
Var s integer;
wait(s)//用于申请资源
{
	while s≤0 do no-op; //整型信号量值≤0时循环执行空操作
	s=s-1
}
signal(s)//用于释放资源
{
	s=s+1;
}
```
##### (2)用整型信号量实现进程互斥

用整型信号量实现进程互斥的思想是：为必须互斥访问的临界资源CS定义一个互斥信号量mutex,将初始值置为1，然后将CS放入wait(mutex)和signal(mutex)之间。当CS可访问时，wait(mutex)才能正常结束使进程进入CS。


