# 1.6.精讲6

## 一、用户数据报协议（UDP）

用户数据报协议（User Datagram Protocol UDP）：Internet传输层协议，提供无连接、不可靠、数据报尽力传输服务。

### 1.1 UDP特点

1. 应用进程容易控制发送什么数据以及何时发送，会出现分组丢失和重复。
2. 无需建立连接。
3. 无连接状态。
4. 首部开销小，只有8个字节。

### 1.2 UDP数据报结构

1. UDP数据报首部：源端口号（16位）、目的端口号（16位）、长度（16位）、校验和（16位），一共8字节。
2. UDP数据报数据字段：应用数据

### 1.3 UDP校验和

1. 提供差错检测功能，UDP的校验和用于检测UDP报文段从源到目的地传送过程中，其中数据是否发生了改变。
2. UDP校验和计算的内容包括3部分：UDP伪首部、UDP首部、应用数据。

### 1.4 UDP伪首部结构

1. 源IP地址、目的IP地址、协议号：对应封装UDP数据报的IP分组的字段。
2. UDP长度字段：是该UDP数据报的字段，该字段参与计算两次。
3. UDP协议号：17。

### 1.5 UDP校验和计算规则

1. 所有参与运算内容按16位对齐求和。
2. 求和过程中遇到溢出（即进位）都被回卷（即进位与最低位再相加），最后得到的和取反码，就是UDP的校验和，填入UDP数据报的校验和字段。
3. UDP再生成校验和的时候，校验和字段全取0。

## 二、传输控制协议（TCP）

### 2.1 TCP报文段结构

传输控制协议(Transmission Control Protocol ,TCP)：Internet传输层协议。提供面向连接、可靠、有序、字节流 传输服务。

第一、应用进程先建立连接。
第二、每一条TCP连接只有两个端点。
第三、可靠交付：无差错，不丢失，不重复，按序到达
第四、全双工通信。
第五、面向字节流。

流：字节序列。应用程序和TCP的交互是一个个数据块，TCP把他们看做是无结构字节。

```mermaid
graph LR
应用层报文-->传输层TCP报文段
```

最大报文段长度（Maximum Segment Size,MSS）：报文段中封装的应用层数据的最大长度。


1. 源端口号字段，目的端口号字段分别占16位。复用/分解来自/送到上层应用的数据。
2. 序号字段、确认序号字段分别占32位。
      序号字段：TCP的序号是对每个应用层数据的每个字节进行编号；
      确认序号字段：是期望从对方接收数据的字节序号，即该序号对应的字节尚未收到；
3. 首部长度字段占4位。指出TCP段的首部长度，以4字节为计算单位。最短是20字节；最长是60字节。
4. 保留字段占6位。保留为今后使用，目前值为0。

5. URG、ACK、PSH、RST、SYN、FIN各占1位。为标志位字段；各占1位，取值为0或1；
	紧急URG=1，紧急指针字段有效，优先传送。
	确认ACK=1，确认序号字段有效；ACK=0时，确认序号字段无效。
	推送PSH=1，尽快将报文段中的数据交付接收应用进程，不要等缓存满了再交付。
	复位RST=1，TCP连接出现严重差错，释放连接，再重新建立TCP连接。
	同步SYN=1，该TCP报文段是一个建立新连接请求控制段或者同意建立新连接的确认段。
	终止FIN=1，TCP报文段的发送端数据已经发送完毕，请求释放连接。
6. 接收窗口字段占16位。向对方通告我方接收窗口的大小。
7. 校验和字段占16位。校验和字段检验的范围类似于UDP，计算方法与UDP校验和的计算方法相同。TCP协议号是6。
8. 紧急指针字段占16位。URG=1时，才有效。指出在本TCP报文段中紧急数据共有多少个字节
9. 选项字段长度可变，基本不用。最短为0字节，最长为40字节。
10. 填充字段，取值全为0，目的是为了整个首部长度是4字节的整倍数。

要点：
1. 序号字段：TCP的序号是对每个应用层数据的每个字节进行编号，
2. 确认序号字段：是期望从对方接收数据的字节序号，即该序号对应的字节尚未收到。用ack_seq表示。
3. TCP段的首部长度最短是20字节。

### 2.2 TCP连接管理

TCP连接管理：连接建立与连接拆除。

#### TCP连接建立：

第一次握手：
客户向服务器发送连接请求段：SYN=1,seq=x
SYN=1：建立连接请求控制段
seq=x：表示传输的报文段的第1个数据字节的序列号是x，并以此序列号代表整个报文段的序号
           （补充：sequence number，序号的意思。）
客户端进入SYN_SEND（同步发送） 

第二次握手：服务器收到TCP连接请求段后，如同意，则发回确认报文段：
（SYN=1,ACK=1,seq=y, ack_seq=x+1）
SYN=1：同意建立新连接的确认段
ack_seq=x+1：表示已经收到了序列号为x的报文段，准备接收序列号为x+1的报文段。
seq=y：服务器告诉客户确认报文段的序列号是y。
服务器由LISTEN进入SYN_RCVD（同步收到）


第三次握手：客户对服务器的 同意连接报文段 进行确认：
（ACK=1,seq=x+1,ack_seq=y+1）
seq=x+1：客户此次的报文段的序列号是x+1。
ack_seq=y+1：客户期望接收服务器序列号为y+1的报文段。
当客户发送ACK时，客户端进入ESTABLISHED状态；
当服务收到ACK后，也进入ESTABLISHED状态；

只有第三次握手可携带数据。

#### TCP连接拆除：

第一次挥手：客户向服务器发送释放连接报文段：（FIN=1,seq=u）
  FIN=1：发送端数据发送完毕，请求释放连接。
  seq=u：传输的第一个数据字节的序号是u
客户端状态由ESTABLISHED进入FIN_WAIT_1（终止等待1状态）

第二次挥手：服务器向客户发送确认段：（ACK=1,seq=v,ack_seq=u+1）
 ACK=1：确认字号段有效。
 ack_seq=u+1：服务器期望接收客户数据序号为u+1。
 seq=v：服务器传输的数据序号是v。
服务器状态由ESTABLISHED进入CLOSE_WAIT（关闭等待）
客户端收到ACK段后，由FIN_WAIT_1进入FIN_WAIT_2

第三次挥手：服务器向客户发送释放连接报文段：（FIN=1,ACK=1,seq=w,ack_seq=u+1）
 FIN=1：请求释放连接
 ACK=1：确认字号段有效。
 ack_seq=u+1：表示服务器期望接收客户数据序号为u+1。
 seq=w：表示自己传输的第一个数据字节的序号是w。
服务器状态由CLOSE_WAIT进入LAST_ACK（最后确认状态）

第四次挥手：客户向服务器发送确认段：（ACK=1,seq=u+1,ack_seq=w+1）
 ACK=1：确认字号段有效。
 ack_seq=w+1：表示客户期望接收服务器数据序号为w+1。
 seq=u+1：表示客户传输的数据的序号是u+1。
客户端状态由FIN_WAIT_2进入TIME_WAIT，等待2MSL时间，进入CLOSED状态。
服务器在收到最后一次ACK后，由LAST_ACK进入CLOSED。


### 2.3 TCP可靠数据传输

TCP实现可靠数据传输服务的工作机制：
	可靠：保证接收方应用进程从缓冲区读出的字节流与发送方发出的字节流是完全一样的。

一、TCP实现可靠数据传输服务的工作机制：
1、应用层数据被分割成TCP认为最适合发送的数据块。
2、TCP发出一个段后，启动一个计时器，等待目的端确认收到这个报文段。
3、TCP首部中设有校验和字段，用于检测数据在传输过程中是否发生差错。
4、TCP报文段到目的端可能会失序，TCP会重新排序。
5、接收端收到重复的报文段，接收端根据序号把重复的报文段丢弃。
6、TCP提供流量控制。

保证接收方进程从缓冲区读出的字节流与发送方发出的字节流是完全一样的。 

1、校验：与UDP一样 
2、序号 
3、确认
4、重传 
5、计时器

序号：应用层数据被分割成TCP认为最适合发送的数据块。一个字节占用一个序号。序号字段指的就是一个报文段第一个字节的序号。 

确认：TCP采用累积确认。此时返回确认序号为4。

TCP生成ACK的策略：

1、具有所期望序号的报文段按序到达，所有在期望序号及以前的报文段都已被确认。TCP延迟500ms发送ACK。
2、具有所期望序号的报文段按序到达、且另一个按序报文段在等待ACK传输，TCP接收方立即发送单个累计ACK，确认以上两个按序到达报文段。
3、拥有序号大于期望序号的失序报文段到达，TCP接收方立即发送重复ACK，指示下一个期望接收字节的序号。
4、收到一个报文段，部分或完全填充接收数据间隔。

重传：快速重传: TCP发送方接收到对相同序号的3次重复ACK，就说明被重复确认的报文段已丢失，这时候即便没有超时，也会重发该报文段。

计时器：计时器超时时间的调整。

计时器超时时间设置：
TimeoutInerval=EstimatedRTT+4×DevRTT

EstimatedRTT：抽样RTT的加权移动平均值。
DevRTT：偏差RTT

### 2.4 TCP流量控制

### 2.5 TCP拥塞控制

